-- ═══════════════════════════════════════════════════════════════
-- ☯ K9 UI LIBRARY - VERSÃO FINAL CORRIGIDA
-- Parte 1/4: Estrutura Base e Serviços
-- ═══════════════════════════════════════════════════════════════

local K9Library = {}
local Utility = {}
local Objects = {}
local Connections = {}

local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

local Mouse = pcall(function() return LocalPlayer:GetMouse() end) and LocalPlayer:GetMouse() or nil

local CustomFont = nil
pcall(function()
    CustomFont = Font.new("rbxassetid://12187375716")
end)
if not CustomFont then
    CustomFont = Font.fromEnum(Enum.Font.Gotham)
end

local Config = {
    Font = CustomFont,
    Theme = {
        Background = Color3.fromRGB(20, 20, 25),
        Glass = Color3.fromRGB(30, 30, 40),
        Accent = Color3.fromRGB(100, 150, 255),
        Text = Color3.fromRGB(255, 255, 255),
        TextSecondary = Color3.fromRGB(180, 180, 190),
        Border = Color3.fromRGB(60, 60, 80)
    },
    ParticleConfig = {
        ParticleCount = 40,
        Speed = 0.2,
        ConnectionDistance = 100,
        ParticleColor = Color3.fromRGB(100, 150, 255),
        LineColor = Color3.fromRGB(100, 150, 255),
        ParticleSize = 3,
        ParticleTransparency = 0.6,
        LineTransparency = 0.8,
        MaxConnectionsPerParticle = 3
    },
    Sizes = {
        MainWidth = 500,        MainHeight = 350,
        TabWidth = 140,
        ElementHeight = 40,
        CornerRadius = 10
    }
}

function Utility:TweenObject(obj, properties, duration, style, direction)
    pcall(function()
        local tween = TweenService:Create(
            obj, 
            TweenInfo.new(duration or 0.2, style or Enum.EasingStyle.Quad, direction or Enum.EasingDirection.Out), 
            properties
        )
        tween:Play()
    end)
end

function Utility:CreateInstance(class, properties, parent)
    local success, obj = pcall(function()
        local instance = Instance.new(class)
        for prop, value in pairs(properties or {}) do
            pcall(function() instance[prop] = value end)
        end
        if parent then instance.Parent = parent end
        return instance
    end)
    return success and obj or nil
end

local LibName = "K9_" .. math.random(1000, 9999)
local MainGUI = nil
local ParticleSystem = nil
local CurrentTheme = Config.Theme
local MainFrame = nil
local ContentContainer = nil
local TabsFolder = nil
local tabButtons = {}

function K9Library:ToggleUI()
    pcall(function()
        if MainGUI then
            MainGUI.Enabled = not MainGUI.Enabled
        end
    end)
end

function K9Library:Destroy()
    pcall(function()
        if ParticleSystem then ParticleSystem:Destroy() end        if MainGUI then MainGUI:Destroy() end
    end)
    for _, conn in ipairs(Connections) do
        pcall(function() conn:Disconnect() end)
    end
    Connections = {}
end

function K9Library:ChangeTheme(newTheme)
    for key, value in pairs(newTheme) do
        CurrentTheme[key] = value
    end
end

function K9Library:Notify(title, message, duration)
    duration = duration or 3
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "K9 Menu | " .. title,
            Text = message,
            Duration = duration
        })
    end)
end

function K9Library:CreateParticleNetwork(parent, customConfig)
    local particleConfig = {}
    for key, value in pairs(Config.ParticleConfig) do
        particleConfig[key] = value
    end
    if customConfig then
        for key, value in pairs(customConfig) do
            particleConfig[key] = value
        end
    end
    
    local container = Utility:CreateInstance("Frame", {
        Name = "ParticleContainer",
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        ClipsDescendants = true,
        ZIndex = 0
    }, parent)
    
    local particles = {}
    local connections = {}
    local running = true
        for i = 1, particleConfig.ParticleCount do
        local particle = Utility:CreateInstance("Frame", {
            Name = "Particle_" .. i,
            BackgroundColor3 = particleConfig.ParticleColor,
            BackgroundTransparency = particleConfig.ParticleTransparency,
            BorderSizePixel = 0,
            Size = UDim2.new(0, particleConfig.ParticleSize, 0, particleConfig.ParticleSize),
            Position = UDim2.new(math.random() * 0.8 + 0.1, 0, math.random() * 0.8 + 0.1, 0),
            ZIndex = 1
        }, container)
        
        Utility:CreateInstance("UICorner", {CornerRadius = UDim.new(1, 0)}, particle)
        
        table.insert(particles, {
            Instance = particle,
            Velocity = Vector2.new(
                (math.random() - 0.5) * particleConfig.Speed,
                (math.random() - 0.5) * particleConfig.Speed
            )
        })
    end
    
    local function createLine(p1, p2, transparency)
        local distance = (p1 - p2).Magnitude
        if distance == 0 then return nil end
        
        local midpoint = (p1 + p2) / 2
        local angle = math.atan2(p2.Y - p1.Y, p2.X - p1.X)
        
        return Utility:CreateInstance("Frame", {
            BackgroundColor3 = particleConfig.LineColor,
            BackgroundTransparency = transparency,
            BorderSizePixel = 0,
            Size = UDim2.new(0, distance, 0, 1),
            Position = UDim2.new(0, midpoint.X - distance / 2, 0, midpoint.Y - 0.5),
            Rotation = math.deg(angle),
            ZIndex = 0
        }, container)
    end
    
    local renderConnection
    renderConnection = RunService.RenderStepped:Connect(function()
        if not running or not container.Parent then
            if renderConnection then renderConnection:Disconnect() end
            return
        end
        
        local containerSize = container.AbsoluteSize
        
        for _, particleData in ipairs(particles) do            local particle = particleData.Instance
            local pos = particle.Position
            local newX = pos.X.Offset + particleData.Velocity.X
            local newY = pos.Y.Offset + particleData.Velocity.Y
            
            if newX <= 0 or newX >= containerSize.X - particleConfig.ParticleSize then
                particleData.Velocity = Vector2.new(-particleData.Velocity.X, particleData.Velocity.Y)
            end
            if newY <= 0 or newY >= containerSize.Y - particleConfig.ParticleSize then
                particleData.Velocity = Vector2.new(particleData.Velocity.X, -particleData.Velocity.Y)
            end
            
            pcall(function()
                particle.Position = UDim2.new(
                    pos.X.Scale,
                    math.clamp(newX, 0, containerSize.X - particleConfig.ParticleSize),
                    pos.Y.Scale,
                    math.clamp(newY, 0, containerSize.Y - particleConfig.ParticleSize)
                )
            end)
        end
        
        for _, line in ipairs(connections) do
            pcall(function() line:Destroy() end)
        end
        connections = {}
        
        local maxConnections = particleConfig.MaxConnectionsPerParticle
        for i = 1, #particles do
            local connectionCount = 0
            for j = i + 1, #particles do
                if connectionCount >= maxConnections then break end
                
                local pos1 = particles[i].Instance.AbsolutePosition + particles[i].Instance.AbsoluteSize / 2
                local pos2 = particles[j].Instance.AbsolutePosition + particles[j].Instance.AbsoluteSize / 2
                local distance = (pos1 - pos2).Magnitude
                
                if distance <= particleConfig.ConnectionDistance then
                    local transparency = math.clamp(1 - (distance / particleConfig.ConnectionDistance), 
                        particleConfig.LineTransparency - 0.2, particleConfig.LineTransparency + 0.2)
                    local line = createLine(pos1, pos2, transparency)
                    if line then
                        table.insert(connections, line)
                        connectionCount = connectionCount + 1
                    end
                end
            end
        end
    end)
        return {
        Container = container,
        Destroy = function()
            running = false
            if renderConnection then renderConnection:Disconnect() end
            for _, line in ipairs(connections) do pcall(function() line:Destroy() end) end
            pcall(function() container:Destroy() end)
        end
    }
end

print("[K9 UI] Parte 1/4 Carregada")
-- ═══════════════════════════════════════════════════════════════
-- ☯ K9 UI LIBRARY - VERSÃO FINAL CORRIGIDA
-- Parte 2/4: UI Principal
-- ═══════════════════════════════════════════════════════════════

function K9Library:CreateLib(libName, customTheme)
    if customTheme then
        for key, value in pairs(customTheme) do
            CurrentTheme[key] = value
        end
    end
    
    pcall(function()
        for _, gui in ipairs(CoreGui:GetChildren()) do
            if gui:IsA("ScreenGui") and gui.Name:find("K9_") then
                gui:Destroy()
            end
        end
    end)
    
    MainGUI = Instance.new("ScreenGui")
    MainGUI.Name = libName or "K9_Library"
    MainGUI.ResetOnSpawn = false
    MainGUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    MainGUI.DisplayOrder = 100
    MainGUI.IgnoreGuiInset = true
    MainGUI.Parent = CoreGui
    
    MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = MainGUI
    MainFrame.BackgroundColor3 = CurrentTheme.Background
    MainFrame.BackgroundTransparency = 0.15
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    MainFrame.Size = UDim2.new(0, Config.Sizes.MainWidth, 0, Config.Sizes.MainHeight)
    MainFrame.ClipsDescendants = true
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, Config.Sizes.CornerRadius)
    MainCorner.Parent = MainFrame
    
    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Parent = MainFrame
    Header.BackgroundColor3 = CurrentTheme.Glass
    Header.BackgroundTransparency = 0.3
    Header.BorderSizePixel = 0
    Header.Size = UDim2.new(1, 0, 0, 40)    
    local HeaderCorner = Instance.new("UICorner")
    HeaderCorner.CornerRadius = UDim.new(0, Config.Sizes.CornerRadius)
    HeaderCorner.Parent = Header
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Name = "TitleLabel"
    TitleLabel.Parent = Header
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Position = UDim2.new(0, 12, 0, 0)
    TitleLabel.Size = UDim2.new(0.6, 0, 1, 0)
    TitleLabel.FontFace = Config.Font
    TitleLabel.Text = "K9 " .. (libName or "Library")
    TitleLabel.TextColor3 = CurrentTheme.Text
    TitleLabel.TextSize = 16
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    local CloseButton = Instance.new("ImageButton")
    CloseButton.Name = "CloseButton"
    CloseButton.Parent = Header
    CloseButton.BackgroundTransparency = 1
    CloseButton.Position = UDim2.new(1, -10, 0.5, 0)
    CloseButton.AnchorPoint = Vector2.new(1, 0.5)
    CloseButton.Size = UDim2.new(0, 24, 0, 24)
    CloseButton.Image = "rbxassetid://3926305904"
    CloseButton.ImageRectOffset = Vector2.new(284, 4)
    CloseButton.ImageRectSize = Vector2.new(24, 24)
    CloseButton.ImageColor3 = CurrentTheme.Text
    
    local Navigation = Instance.new("Frame")
    Navigation.Name = "Navigation"
    Navigation.Parent = MainFrame
    Navigation.BackgroundColor3 = CurrentTheme.Glass
    Navigation.BackgroundTransparency = 0.5
    Navigation.BorderSizePixel = 0
    Navigation.Position = UDim2.new(0, 0, 0, 40)
    Navigation.Size = UDim2.new(0, Config.Sizes.TabWidth, 1, -40)
    Navigation.ClipsDescendants = true
    
    local NavCorner = Instance.new("UICorner")
    NavCorner.CornerRadius = UDim.new(0, 0, 0, Config.Sizes.CornerRadius)
    NavCorner.Parent = Navigation
    
    local NavListLayout = Instance.new("UIListLayout")
    NavListLayout.Parent = Navigation
    NavListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    NavListLayout.Padding = UDim.new(0, 4)
    
    local NavPadding = Instance.new("UIPadding")
    NavPadding.Parent = Navigation    NavPadding.PaddingTop = UDim.new(0, 8)
    NavPadding.PaddingBottom = UDim.new(0, 8)
    NavPadding.PaddingLeft = UDim.new(0, 6)
    NavPadding.PaddingRight = UDim.new(0, 6)
    
    ContentContainer = Instance.new("ScrollingFrame")
    ContentContainer.Name = "ContentContainer"
    ContentContainer.Parent = MainFrame
    ContentContainer.BackgroundTransparency = 1
    ContentContainer.BorderSizePixel = 0
    ContentContainer.Position = UDim2.new(0, Config.Sizes.TabWidth, 0, 40)
    ContentContainer.Size = UDim2.new(1, -Config.Sizes.TabWidth, 1, -40)
    ContentContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    ContentContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ContentContainer.ScrollBarThickness = 4
    ContentContainer.ScrollBarImageColor3 = CurrentTheme.Accent
    ContentContainer.ClipsDescendants = true
    
    local ContentPadding = Instance.new("UIPadding")
    ContentPadding.Parent = ContentContainer
    ContentPadding.PaddingTop = UDim.new(0, 10)
    ContentPadding.PaddingBottom = UDim.new(0, 10)
    ContentPadding.PaddingLeft = UDim.new(0, 10)
    ContentPadding.PaddingRight = UDim.new(0, 10)
    
    local ContentListLayout = Instance.new("UIListLayout")
    ContentListLayout.Parent = ContentContainer
    ContentListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    ContentListLayout.Padding = UDim2.new(0, 8)
    
    TabsFolder = Instance.new("Folder")
    TabsFolder.Parent = ContentContainer
    
    ParticleSystem = K9Library:CreateParticleNetwork(MainFrame, Config.ParticleConfig)
    
    local dragging = false
    local dragInput = nil
    local mousePos = nil
    local framePos = nil
    
    Header.InputBegan:Connect(function(input)
        pcall(function()
            if input.UserInputType == Enum.UserInputType.MouseButton1 or 
               input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                mousePos = input.Position
                framePos = MainFrame.Position
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then                        dragging = false
                    end
                end)
            end
        end)
    end)
    
    Header.InputChanged:Connect(function(input)
        pcall(function()
            if input.UserInputType == Enum.UserInputType.MouseMovement or 
               input.UserInputType == Enum.UserInputType.Touch then
                dragInput = input
            end
        end)
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        pcall(function()
            if input == dragInput and dragging then
                local delta = input.Position - mousePos
                MainFrame.Position = UDim2.new(
                    framePos.X.Scale, framePos.X.Offset + delta.X,
                    framePos.Y.Scale, framePos.Y.Offset + delta.Y
                )
            end
        end)
    end)
    
    CloseButton.MouseButton1Click:Connect(function()
        Utility:TweenObject(MainFrame, {Size = UDim2.new(0, 0, 0, 0)}, 0.3)
        task.wait(0.3)
        if ParticleSystem then ParticleSystem:Destroy() end
        MainGUI:Destroy()
    end)
    
    local Tabs = {}
    local firstTab = true
    tabButtons = {}
    
    function Tabs:NewTab(tabName, tabIcon)
        tabName = tabName or "Tab"
        
        local TabButton = Instance.new("TextButton")
        TabButton.Name = tabName .. "_TabButton"
        TabButton.Parent = Navigation
        TabButton.BackgroundTransparency = 1
        TabButton.Size = UDim2.new(1, 0, 0, 36)
        TabButton.FontFace = Config.Font
        TabButton.Text = "  " .. tabName
        TabButton.TextColor3 = CurrentTheme.TextSecondary        TabButton.TextSize = 13
        TabButton.TextXAlignment = Enum.TextXAlignment.Left
        TabButton.AutoButtonColor = false
        
        local ButtonCorner = Instance.new("UICorner")
        ButtonCorner.CornerRadius = UDim.new(0, 6)
        ButtonCorner.Parent = TabButton
        
        local Selector = Instance.new("Frame")
        Selector.Name = "Selector"
        Selector.Parent = TabButton
        Selector.BackgroundColor3 = CurrentTheme.Accent
        Selector.Position = UDim2.new(0, 0, 0.5, 0)
        Selector.AnchorPoint = Vector2.new(0, 0.5)
        Selector.Size = UDim2.new(0, 3, 0, 20)
        Selector.Visible = false
        
        local SelectorCorner = Instance.new("UICorner")
        SelectorCorner.CornerRadius = UDim.new(0, 2)
        SelectorCorner.Parent = Selector
        
        local TabContent = Instance.new("Frame")
        TabContent.Name = tabName .. "_Content"
        TabContent.Parent = TabsFolder
        TabContent.BackgroundTransparency = 1
        TabContent.Size = UDim2.new(1, 0, 0, 0)
        TabContent.Visible = false
        
        local TabContentLayout = Instance.new("UIListLayout")
        TabContentLayout.Parent = TabContent
        TabContentLayout.SortOrder = Enum.SortOrder.LayoutOrder
        TabContentLayout.Padding = UDim2.new(0, 6)
        
        if firstTab then
            firstTab = false
            TabContent.Visible = true
            TabButton.BackgroundTransparency = 0.8
            TabButton.TextColor3 = CurrentTheme.Text
            Selector.Visible = true
        end
        
        TabButton.MouseButton1Click:Connect(function()
            for _, content in ipairs(TabsFolder:GetChildren()) do
                if content:IsA("Frame") then content.Visible = false end
            end
            for _, btn in ipairs(tabButtons) do
                Utility:TweenObject(btn, {BackgroundTransparency = 1}, 0.2)
                Utility:TweenObject(btn, {TextColor3 = CurrentTheme.TextSecondary}, 0.2)
                local sel = btn:FindFirstChild("Selector")
                if sel then sel.Visible = false end            end
            TabContent.Visible = true
            Utility:TweenObject(TabButton, {BackgroundTransparency = 0.8}, 0.2)
            Utility:TweenObject(TabButton, {TextColor3 = CurrentTheme.Text}, 0.2)
            Selector.Visible = true
            task.wait(0.1)
            ContentContainer.CanvasSize = UDim2.new(0, 0, 0, TabContentLayout.AbsoluteContentSize.Y + 20)
        end)
        
        table.insert(tabButtons, TabButton)
        
        local Sections = {}
        
        function Sections:NewSection(sectionName)
            sectionName = sectionName or "Section"
            
            local SectionFrame = Instance.new("Frame")
            SectionFrame.Name = sectionName .. "_Section"
            SectionFrame.Parent = TabContent
            SectionFrame.BackgroundColor3 = CurrentTheme.Glass
            SectionFrame.BackgroundTransparency = 0.7
            SectionFrame.BorderSizePixel = 0
            SectionFrame.Size = UDim2.new(1, 0, 0, 0)
            SectionFrame.ClipsDescendants = true
            
            local SectionCorner = Instance.new("UICorner")
            SectionCorner.CornerRadius = UDim.new(0, 8)
            SectionCorner.Parent = SectionFrame
            
            local SectionStroke = Instance.new("UIStroke")
            SectionStroke.Parent = SectionFrame
            SectionStroke.Thickness = 1
            SectionStroke.Color = CurrentTheme.Border
            SectionStroke.Transparency = 0.5
            SectionStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
            
            local SectionTitle = Instance.new("TextLabel")
            SectionTitle.Name = "SectionTitle"
            SectionTitle.Parent = SectionFrame
            SectionTitle.BackgroundTransparency = 1
            SectionTitle.Position = UDim2.new(0, 12, 0, 0)
            SectionTitle.Size = UDim2.new(1, -24, 0, 30)
            SectionTitle.FontFace = Config.Font
            SectionTitle.Text = sectionName
            SectionTitle.TextColor3 = CurrentTheme.Accent
            SectionTitle.TextSize = 13
            SectionTitle.TextXAlignment = Enum.TextXAlignment.Left
            
            local SectionContent = Instance.new("Frame")
            SectionContent.Name = "SectionContent"            SectionContent.Parent = SectionFrame
            SectionContent.BackgroundTransparency = 1
            SectionContent.Position = UDim2.new(0, 0, 0, 30)
            SectionContent.Size = UDim2.new(1, 0, 1, -30)
            SectionContent.ClipsDescendants = true
            
            local SectionLayout = Instance.new("UIListLayout")
            SectionLayout.Parent = SectionContent
            SectionLayout.SortOrder = Enum.SortOrder.LayoutOrder
            SectionLayout.Padding = UDim2.new(0, 4)
            
            local SectionPadding = Instance.new("UIPadding")
            SectionPadding.Parent = SectionContent
            SectionPadding.PaddingTop = UDim2.new(0, 8)
            SectionPadding.PaddingBottom = UDim2.new(0, 8)
            SectionPadding.PaddingLeft = UDim2.new(0, 8)
            SectionPadding.PaddingRight = UDim2.new(0, 8)
            
            local function UpdateSectionSize()
                local contentSize = SectionLayout.AbsoluteContentSize.Y + 16
                Utility:TweenObject(SectionFrame, {Size = UDim2.new(1, 0, 0, contentSize + 30)}, 0.2)
                ContentContainer.CanvasSize = UDim2.new(0, 0, 0, TabContentLayout.AbsoluteContentSize.Y + 20)
            end
            
            task.wait(0.1)
            UpdateSectionSize()
            SectionLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(UpdateSectionSize)
            
            local Elements = {}
            
            return Elements
        end
        
        return Sections
    end
    
    return Tabs
end

print("[K9 UI] Parte 2/4 Carregada")
-- ═══════════════════════════════════════════════════════════════
-- ☯ K9 UI LIBRARY - VERSÃO FINAL CORRIGIDA
-- Parte 3/4: Elementos
-- ═══════════════════════════════════════════════════════════════

function Elements:NewButton(buttonName, callback)
    callback = callback or function() end
    
    local ButtonFrame = Instance.new("TextButton")
    ButtonFrame.Name = buttonName .. "_Button"
    ButtonFrame.Parent = SectionContent
    ButtonFrame.BackgroundColor3 = CurrentTheme.Glass
    ButtonFrame.BackgroundTransparency = 0.6
    ButtonFrame.BorderSizePixel = 0
    ButtonFrame.Size = UDim2.new(1, 0, 0, Config.Sizes.ElementHeight)
    ButtonFrame.AutoButtonColor = false
    ButtonFrame.FontFace = Config.Font
    ButtonFrame.Text = ""
    ButtonFrame.ClipsDescendants = true
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 6)
    ButtonCorner.Parent = ButtonFrame
    
    local ButtonStroke = Instance.new("UIStroke")
    ButtonStroke.Parent = ButtonFrame
    ButtonStroke.Thickness = 1
    ButtonStroke.Color = CurrentTheme.Border
    ButtonStroke.Transparency = 0.5
    ButtonStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    local ButtonTitle = Instance.new("TextLabel")
    ButtonTitle.Name = "ButtonTitle"
    ButtonTitle.Parent = ButtonFrame
    ButtonTitle.BackgroundTransparency = 1
    ButtonTitle.Position = UDim2.new(0, 12, 0, 0)
    ButtonTitle.Size = UDim2.new(1, -24, 1, 0)
    ButtonTitle.FontFace = Config.Font
    ButtonTitle.Text = buttonName
    ButtonTitle.TextColor3 = CurrentTheme.Text
    ButtonTitle.TextSize = 13
    ButtonTitle.TextXAlignment = Enum.TextXAlignment.Left
    
    ButtonFrame.MouseButton1Click:Connect(function()
        pcall(callback)
    end)
    
    UpdateSectionSize()
    
    return {}end

function Elements:NewToggle(toggleName, default, callback)
    default = default or false
    callback = callback or function(state) end
    local toggled = default
    
    local ToggleFrame = Instance.new("TextButton")
    ToggleFrame.Name = toggleName .. "_Toggle"
    ToggleFrame.Parent = SectionContent
    ToggleFrame.BackgroundColor3 = CurrentTheme.Glass
    ToggleFrame.BackgroundTransparency = 0.6
    ToggleFrame.BorderSizePixel = 0
    ToggleFrame.Size = UDim2.new(1, 0, 0, Config.Sizes.ElementHeight)
    ToggleFrame.AutoButtonColor = false
    ToggleFrame.FontFace = Config.Font
    ToggleFrame.Text = ""
    ToggleFrame.ClipsDescendants = true
    
    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 6)
    ToggleCorner.Parent = ToggleFrame
    
    local ToggleStroke = Instance.new("UIStroke")
    ToggleStroke.Parent = ToggleFrame
    ToggleStroke.Thickness = 1
    ToggleStroke.Color = CurrentTheme.Border
    ToggleStroke.Transparency = 0.5
    ToggleStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    local ToggleTitle = Instance.new("TextLabel")
    ToggleTitle.Name = "ToggleTitle"
    ToggleTitle.Parent = ToggleFrame
    ToggleTitle.BackgroundTransparency = 1
    ToggleTitle.Position = UDim2.new(0, 12, 0, 0)
    ToggleTitle.Size = UDim2.new(1, -70, 1, 0)
    ToggleTitle.FontFace = Config.Font
    ToggleTitle.Text = toggleName
    ToggleTitle.TextColor3 = CurrentTheme.Text
    ToggleTitle.TextSize = 13
    ToggleTitle.TextXAlignment = Enum.TextXAlignment.Left
    
    local ToggleIndicator = Instance.new("Frame")
    ToggleIndicator.Name = "ToggleIndicator"
    ToggleIndicator.Parent = ToggleFrame
    ToggleIndicator.BackgroundColor3 = CurrentTheme.Border
    ToggleIndicator.Position = UDim2.new(1, -12, 0.5, 0)
    ToggleIndicator.AnchorPoint = Vector2.new(1, 0.5)
    ToggleIndicator.Size = UDim2.new(0, 40, 0, 20)
        local IndicatorCorner = Instance.new("UICorner")
    IndicatorCorner.CornerRadius = UDim.new(1, 0)
    IndicatorCorner.Parent = ToggleIndicator
    
    local IndicatorCircle = Instance.new("Frame")
    IndicatorCircle.Name = "IndicatorCircle"
    IndicatorCircle.Parent = ToggleIndicator
    IndicatorCircle.BackgroundColor3 = CurrentTheme.Text
    IndicatorCircle.Position = UDim2.new(0, 3, 0.5, 0)
    IndicatorCircle.AnchorPoint = Vector2.new(0, 0.5)
    IndicatorCircle.Size = UDim2.new(0, 16, 0, 16)
    
    local CircleCorner = Instance.new("UICorner")
    CircleCorner.CornerRadius = UDim.new(1, 0)
    CircleCorner.Parent = IndicatorCircle
    
    local function UpdateToggleState()
        if toggled then
            Utility:TweenObject(ToggleIndicator, {BackgroundColor3 = CurrentTheme.Accent}, 0.2)
            Utility:TweenObject(IndicatorCircle, {Position = UDim2.new(1, -19, 0.5, 0)}, 0.2)
        else
            Utility:TweenObject(ToggleIndicator, {BackgroundColor3 = CurrentTheme.Border}, 0.2)
            Utility:TweenObject(IndicatorCircle, {Position = UDim2.new(0, 3, 0.5, 0)}, 0.2)
        end
    end
    
    UpdateToggleState()
    
    ToggleFrame.MouseButton1Click:Connect(function()
        toggled = not toggled
        UpdateToggleState()
        pcall(function() callback(toggled) end)
    end)
    
    UpdateSectionSize()
    
    local ToggleFunctions = {}
    function ToggleFunctions:SetState(newState)
        toggled = newState
        UpdateToggleState()
        pcall(function() callback(toggled) end)
    end
    function ToggleFunctions:GetState()
        return toggled
    end
    
    return ToggleFunctions
end

function Elements:NewSlider(sliderName, minValue, maxValue, defaultValue, callback)    minValue = minValue or 0
    maxValue = maxValue or 100
    defaultValue = defaultValue or minValue
    callback = callback or function(value) end
    local currentValue = defaultValue
    
    local SliderFrame = Instance.new("Frame")
    SliderFrame.Name = sliderName .. "_Slider"
    SliderFrame.Parent = SectionContent
    SliderFrame.BackgroundColor3 = CurrentTheme.Glass
    SliderFrame.BackgroundTransparency = 0.6
    SliderFrame.BorderSizePixel = 0
    SliderFrame.Size = UDim2.new(1, 0, 0, Config.Sizes.ElementHeight + 20)
    SliderFrame.ClipsDescendants = true
    
    local SliderCorner = Instance.new("UICorner")
    SliderCorner.CornerRadius = UDim.new(0, 6)
    SliderCorner.Parent = SliderFrame
    
    local SliderTitle = Instance.new("TextLabel")
    SliderTitle.Name = "SliderTitle"
    SliderTitle.Parent = SliderFrame
    SliderTitle.BackgroundTransparency = 1
    SliderTitle.Position = UDim2.new(0, 12, 0, 4)
    SliderTitle.Size = UDim2.new(1, -60, 0, 16)
    SliderTitle.FontFace = Config.Font
    SliderTitle.Text = sliderName
    SliderTitle.TextColor3 = CurrentTheme.Text
    SliderTitle.TextSize = 12
    SliderTitle.TextXAlignment = Enum.TextXAlignment.Left
    
    local SliderValue = Instance.new("TextLabel")
    SliderValue.Name = "SliderValue"
    SliderValue.Parent = SliderFrame
    SliderValue.BackgroundTransparency = 1
    SliderValue.Position = UDim2.new(1, -12, 0, 4)
    SliderValue.AnchorPoint = Vector2.new(1, 0)
    SliderValue.Size = UDim2.new(0, 50, 0, 16)
    SliderValue.FontFace = Config.Font
    SliderValue.Text = tostring(currentValue)
    SliderValue.TextColor3 = CurrentTheme.Accent
    SliderValue.TextSize = 12
    SliderValue.TextXAlignment = Enum.TextXAlignment.Right
    
    local SliderBar = Instance.new("Frame")
    SliderBar.Name = "SliderBar"
    SliderBar.Parent = SliderFrame
    SliderBar.BackgroundColor3 = CurrentTheme.Border
    SliderBar.Position = UDim2.new(0, 12, 0, 28)
    SliderBar.Size = UDim2.new(1, -24, 0, 6)    
    local BarCorner = Instance.new("UICorner")
    BarCorner.CornerRadius = UDim.new(1, 0)
    BarCorner.Parent = SliderBar
    
    local SliderProgress = Instance.new("Frame")
    SliderProgress.Name = "SliderProgress"
    SliderProgress.Parent = SliderBar
    SliderProgress.BackgroundColor3 = CurrentTheme.Accent
    SliderProgress.Size = UDim2.new(0, 0, 1, 0)
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = SliderProgress
    
    local function UpdateSliderValue(value)
        currentValue = math.clamp(value, minValue, maxValue)
        SliderValue.Text = tostring(math.floor(currentValue))
        local percentage = (currentValue - minValue) / (maxValue - minValue)
        Utility:TweenObject(SliderProgress, {Size = UDim2.new(percentage, 0, 1, 0)}, 0.1)
        pcall(function() callback(currentValue) end)
    end
    
    UpdateSliderValue(defaultValue)
    
    local dragging = false
    
    SliderBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            UpdateSliderValue(((input.Position.X - SliderBar.AbsolutePosition.X) / SliderBar.AbsoluteSize.X) * (maxValue - minValue) + minValue)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or 
                        input.UserInputType == Enum.UserInputType.Touch) then
            UpdateSliderValue(((input.Position.X - SliderBar.AbsolutePosition.X) / SliderBar.AbsoluteSize.X) * (maxValue - minValue) + minValue)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    UpdateSectionSize()    
    local SliderFunctions = {}
    function SliderFunctions:SetValue(value)
        UpdateSliderValue(value)
    end
    function SliderFunctions:GetValue()
        return currentValue
    end
    
    return SliderFunctions
end

function Elements:NewDropdown(dropdownName, options, default, callback)
    options = options or {"Option 1", "Option 2"}
    default = default or options[1]
    callback = callback or function(option) end
    local selectedOption = default
    local isOpen = false
    
    local DropdownFrame = Instance.new("Frame")
    DropdownFrame.Name = dropdownName .. "_Dropdown"
    DropdownFrame.Parent = SectionContent
    DropdownFrame.BackgroundColor3 = CurrentTheme.Glass
    DropdownFrame.BackgroundTransparency = 0.6
    DropdownFrame.BorderSizePixel = 0
    DropdownFrame.Size = UDim2.new(1, 0, 0, Config.Sizes.ElementHeight)
    DropdownFrame.ClipsDescendants = false
    
    local DropdownCorner = Instance.new("UICorner")
    DropdownCorner.CornerRadius = UDim.new(0, 6)
    DropdownCorner.Parent = DropdownFrame
    
    local DropdownStroke = Instance.new("UIStroke")
    DropdownStroke.Parent = DropdownFrame
    DropdownStroke.Thickness = 1
    DropdownStroke.Color = CurrentTheme.Border
    DropdownStroke.Transparency = 0.5
    DropdownStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    local DropdownTitle = Instance.new("TextLabel")
    DropdownTitle.Name = "DropdownTitle"
    DropdownTitle.Parent = DropdownFrame
    DropdownTitle.BackgroundTransparency = 1
    DropdownTitle.Position = UDim2.new(0, 12, 0, 0)
    DropdownTitle.Size = UDim2.new(0.5, 0, 1, 0)
    DropdownTitle.FontFace = Config.Font
    DropdownTitle.Text = dropdownName
    DropdownTitle.TextColor3 = CurrentTheme.Text
    DropdownTitle.TextSize = 13
    DropdownTitle.TextXAlignment = Enum.TextXAlignment.Left    
    local DropdownButton = Instance.new("TextButton")
    DropdownButton.Name = "DropdownButton"
    DropdownButton.Parent = DropdownFrame
    DropdownButton.BackgroundColor3 = CurrentTheme.Background
    DropdownButton.BackgroundTransparency = 0.5
    DropdownButton.Position = UDim2.new(0.5, -5, 0.5, 0)
    DropdownButton.AnchorPoint = Vector2.new(0, 0.5)
    DropdownButton.Size = UDim2.new(0.5, -10, 0, 24)
    DropdownButton.FontFace = Config.Font
    DropdownButton.Text = "  " .. selectedOption
    DropdownButton.TextColor3 = CurrentTheme.Text
    DropdownButton.TextSize = 12
    DropdownButton.TextXAlignment = Enum.TextXAlignment.Left
    DropdownButton.AutoButtonColor = false
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 4)
    ButtonCorner.Parent = DropdownButton
    
    local ArrowIcon = Instance.new("ImageLabel")
    ArrowIcon.Name = "ArrowIcon"
    ArrowIcon.Parent = DropdownButton
    ArrowIcon.BackgroundTransparency = 1
    ArrowIcon.Position = UDim2.new(1, -8, 0.5, 0)
    ArrowIcon.AnchorPoint = Vector2.new(1, 0.5)
    ArrowIcon.Size = UDim2.new(0, 14, 0, 14)
    ArrowIcon.Image = "rbxassetid://3926305904"
    ArrowIcon.ImageRectOffset = Vector2.new(644, 364)
    ArrowIcon.ImageRectSize = Vector2.new(36, 36)
    ArrowIcon.ImageColor3 = CurrentTheme.TextSecondary
    ArrowIcon.Rotation = 0
    
    local OptionsContainer = Instance.new("ScrollingFrame")
    OptionsContainer.Name = "OptionsContainer"
    OptionsContainer.Parent = DropdownFrame
    OptionsContainer.BackgroundColor3 = CurrentTheme.Background
    OptionsContainer.BackgroundTransparency = 0.7
    OptionsContainer.Position = UDim2.new(0.5, -5, 0, Config.Sizes.ElementHeight + 2)
    OptionsContainer.AnchorPoint = Vector2.new(0, 0)
    OptionsContainer.Size = UDim2.new(0.5, -10, 0, 0)
    OptionsContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    OptionsContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y
    OptionsContainer.ScrollBarThickness = 3
    OptionsContainer.ScrollBarImageColor3 = CurrentTheme.Accent
    OptionsContainer.Visible = false
    OptionsContainer.ZIndex = 10
    
    local OptionsCorner = Instance.new("UICorner")
    OptionsCorner.CornerRadius = UDim.new(0, 4)    OptionsCorner.Parent = OptionsContainer
    
    local OptionsLayout = Instance.new("UIListLayout")
    OptionsLayout.Parent = OptionsContainer
    OptionsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    OptionsLayout.Padding = UDim2.new(0, 2)
    
    local OptionsPadding = Instance.new("UIPadding")
    OptionsPadding.Parent = OptionsContainer
    OptionsPadding.PaddingTop = UDim2.new(0, 4)
    OptionsPadding.PaddingBottom = UDim2.new(0, 4)
    
    for index, option in ipairs(options) do
        local OptionButton = Instance.new("TextButton")
        OptionButton.Name = "Option_" .. index
        OptionButton.Parent = OptionsContainer
        OptionButton.BackgroundColor3 = CurrentTheme.Glass
        OptionButton.BackgroundTransparency = 0.8
        OptionButton.Size = UDim2.new(1, -8, 0, 24)
        OptionButton.Position = UDim2.new(0, 4, 0, 0)
        OptionButton.FontFace = Config.Font
        OptionButton.Text = "  " .. option
        OptionButton.TextColor3 = CurrentTheme.Text
        OptionButton.TextSize = 12
        OptionButton.TextXAlignment = Enum.TextXAlignment.Left
        OptionButton.AutoButtonColor = false
        OptionButton.ZIndex = 11
        
        local OptionCorner = Instance.new("UICorner")
        OptionCorner.CornerRadius = UDim.new(0, 4)
        OptionCorner.Parent = OptionButton
        
        OptionButton.MouseButton1Click:Connect(function()
            selectedOption = option
            DropdownButton.Text = "  " .. selectedOption
            isOpen = false
            Utility:TweenObject(OptionsContainer, {Size = UDim2.new(0.5, -10, 0, 0)}, 0.2)
            Utility:TweenObject(ArrowIcon, {Rotation = 0}, 0.2)
            task.wait(0.2)
            OptionsContainer.Visible = false
            pcall(function() callback(selectedOption) end)
        end)
    end
    
    DropdownButton.MouseButton1Click:Connect(function()
        isOpen = not isOpen
        if isOpen then
            OptionsContainer.Visible = true
            local optionCount = #options
            local targetHeight = math.min(optionCount * 26, 100)            Utility:TweenObject(OptionsContainer, {Size = UDim2.new(0.5, -10, 0, targetHeight)}, 0.2)
            Utility:TweenObject(ArrowIcon, {Rotation = 180}, 0.2)
        else
            Utility:TweenObject(OptionsContainer, {Size = UDim2.new(0.5, -10, 0, 0)}, 0.2)
            Utility:TweenObject(ArrowIcon, {Rotation = 0}, 0.2)
            task.wait(0.2)
            OptionsContainer.Visible = false
        end
    end)
    
    UpdateSectionSize()
    
    local DropdownFunctions = {}
    function DropdownFunctions:GetSelected()
        return selectedOption
    end
    function DropdownFunctions:SetSelected(option)
        if table.find(options, option) then
            selectedOption = option
            DropdownButton.Text = "  " .. selectedOption
            pcall(function() callback(selectedOption) end)
        end
    end
    
    return DropdownFunctions
end

print("[K9 UI] Parte 3/4 Carregada")
-- ═══════════════════════════════════════════════════════════════
-- ☯ K9 UI LIBRARY - VERSÃO FINAL CORRIGIDA
-- Parte 4/4: Finalização
-- ═══════════════════════════════════════════════════════════════

function K9Library:NewWatermark(watermarkText)
    watermarkText = watermarkText or "K9 Library"
    
    local WatermarkGui = Instance.new("ScreenGui")
    WatermarkGui.Name = "K9_Watermark"
    WatermarkGui.ResetOnSpawn = false
    WatermarkGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    WatermarkGui.DisplayOrder = 999
    WatermarkGui.IgnoreGuiInset = true
    WatermarkGui.Parent = CoreGui
    
    local WatermarkFrame = Instance.new("Frame")
    WatermarkFrame.Name = "Watermark"
    WatermarkFrame.Parent = WatermarkGui
    WatermarkFrame.BackgroundColor3 = CurrentTheme.Glass
    WatermarkFrame.BackgroundTransparency = 0.3
    WatermarkFrame.BorderSizePixel = 0
    WatermarkFrame.Position = UDim2.new(0, 10, 0, 10)
    WatermarkFrame.Size = UDim2.new(0, 0, 0, 28)
    WatermarkFrame.ClipsDescendants = true
    
    local WatermarkCorner = Instance.new("UICorner")
    WatermarkCorner.CornerRadius = UDim.new(0, 6)
    WatermarkCorner.Parent = WatermarkFrame
    
    local WatermarkStroke = Instance.new("UIStroke")
    WatermarkStroke.Parent = WatermarkFrame
    WatermarkStroke.Thickness = 1
    WatermarkStroke.Color = CurrentTheme.Accent
    WatermarkStroke.Transparency = 0.5
    WatermarkStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    local WatermarkText = Instance.new("TextLabel")
    WatermarkText.Name = "WatermarkText"
    WatermarkText.Parent = WatermarkFrame
    WatermarkText.BackgroundTransparency = 1
    WatermarkText.Size = UDim2.new(1, 0, 1, 0)
    WatermarkText.FontFace = Config.Font
    WatermarkText.Text = watermarkText
    WatermarkText.TextColor3 = CurrentTheme.Text
    WatermarkText.TextSize = 12
    WatermarkText.TextXAlignment = Enum.TextXAlignment.Center
    
    local function UpdateSize()
        local textBounds = WatermarkText.TextBounds
        Utility:TweenObject(WatermarkFrame, {Size = UDim2.new(0, textBounds.X + 20, 0, 28)}, 0.2)
    end
    
    WatermarkText:GetPropertyChangedSignal("Text"):Connect(UpdateSize)
    task.wait(0.1)
    UpdateSize()
    
    local WatermarkFunctions = {}
    function WatermarkFunctions:SetText(newText)
        watermarkText = newText
        WatermarkText.Text = watermarkText
        UpdateSize()
    end
    function WatermarkFunctions:Destroy()
        pcall(function() WatermarkGui:Destroy() end)
    end
    
    return WatermarkFunctions
end

K9Library.Version = "1.0.0"
K9Library.Author = "K9 Development"

print("[K9 UI] Parte 4/4 Carregada - Library Completa!")
print("[K9 UI] Versao: " .. K9Library.Version)

return K9Library
